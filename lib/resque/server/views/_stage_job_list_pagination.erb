<div class="stages_pagination_block">
  <% total_pages = staged_group_stage.num_jobs / page_size %>
  <% total_pages += 1 if staged_group_stage.num_jobs % page_size > 0 %>
  <% page_num = 1 if page_num > total_pages || page_num < 1 %>
  <% first_page = [1, page_num - 3].max %>
  <% last_page = [total_pages, page_num + 3].min %>
  <% last_page = page_num < 4 ? [total_pages, last_page + (4 - page_num)].min : last_page %>
  <% first_page = page_num > total_pages - 3 ? [1, first_page + ((total_pages - page_num) - 3)].max : first_page %>

  <% if total_pages > 1 %>
    <div class="stages_prev_links">
      <a href="<%= u("stages/stage") %>?<%= { group_stage_id: staged_group_stage.group_stage_id,
                                              sort:           @sort_by,
                                              page_size:      page_size,
                                              page_num:       1,
                                              order:          @sort_order }.to_param %>"
         class="stages_first_page"
         disabled="<%= first_page > 1 %>">
        &lt;&lt; First
      </a>

      <a href="<%= u("stages/stage") %>?<%= { group_stage_id: staged_group_stage.group_stage_id,
                                              sort:           @sort_by,
                                              page_size:      page_size,
                                              page_num:       [1, page_num - 1].max,
                                              order:          @sort_order }.to_param %>"
         class="stages_prev_page"
         disabled="<%= page_num > 1 %>">
        &lt; Prev
      </a>
    </div>

    <div class="stages_pages">
      <% (first_page..last_page).each do |page_number| %>
        <% if page_number != page_num %>
          <a href="<%= u("stages/stage") %>?<%= { group_stage_id: staged_group_stage.group_stage_id,
                                                  sort:           @sort_by,
                                                  page_size:      page_size,
                                                  page_num:       page_number,
                                                  order:          @sort_order }.to_param %>"
             class="stages_page">
            <%= page_number %>
          </a>
        <% else %>
          <%= page_number %>
        <% end %>
      <% end %>
    </div>

    <div class="stages_next_links">
      <a href="<%= u("stages/stage") %>?<%= { group_stage_id: staged_group_stage.group_stage_id,
                                              sort:           @sort_by,
                                              page_size:      page_size,
                                              page_num:       [total_pages, page_num + 1].min,
                                              order:          @sort_order }.to_param %>"
         class="stages_next_page"
         disabled="<%= page_num < last_page %>">
        Next &gt;
      </a>

      <a href="<%= u("stages/stage") %>?<%= { group_stage_id: staged_group_stage.group_stage_id,
                                              sort:           @sort_by,
                                              page_size:      page_size,
                                              page_num:       total_pages,
                                              order:          @sort_order }.to_param %>"
         class="stages_last_page"
         disabled="<%= last_page < total_pages %>">
        Last &gt;&gt;
      </a>
    </div>
  <% end %>
</div>
